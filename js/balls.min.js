const MIN_RADIO=20;const MINV=45;const MAXVX=MINV+MIN_RADIO;const MAXVY=2*MINV;const trazoParedes=43;const anchoParedIzquierda=2*trazoParedes;const RIGHT_WALL_WIDTH=1.2*trazoParedes;const anchoBordeBola=1;const FLOOR_WIDTH=3*trazoParedes;const SIMIL_3D_FLOOR=20;const ROOF_WIDTH=30;const alturaPortal=120;const GRAVITY=1.2;const fps=100;let leftWallPosition=0;let patternLeft;let patternFloor;let patternWall;const imgPinchos=new Image();imgPinchos.src="img/pinchos.png";const imgFloor=new Image();imgFloor.src="img/floor.png";const imgWall=new Image();imgWall.src="img/wall.png";class Ball{static collisionEnabled=false;static indexStatic=0;static fulFillCount=0;hit=false;paused=false;radio=MIN_RADIO+MIN_RADIO*Math.random();x0= -this.radio;y0=FLOOR_WIDTH-SIMIL_3D_FLOOR;vx0=MINV+10*Math.random();vy0=MINV+30*Math.random();run=false;order=null;reason="";createRandomSize=function(){this.x=this.x0;this.y=this.y0;this.vx0/=this.radio/MIN_RADIO;this.vy0/=this.radio/MIN_RADIO};constructor(color,callbackGOAL0,callbackReject0){this.color=color;this.callbackGOAL=(x)=>{this.order= ++Ball.fulFillCount;callbackGOAL0(x)};this.callbackReject=callbackReject0;this.index=Ball.indexStatic;Ball.indexStatic+=1;this.createRandomSize()}}function runBalls(balls){balls.forEach((ball)=>{ball.run=true;ball.paused=false})}function pauseBalls(balls,paused){balls.forEach((ball)=>{ball.paused=paused})}function computeWallCollisions(ball,canvas_width,canvas_height){let hitCeiling=false,hitWall=false,hitFloor=false;if(ball.y<FLOOR_WIDTH-SIMIL_3D_FLOOR&&ball.vy0<0){ball.y=FLOOR_WIDTH-SIMIL_3D_FLOOR;ball.vy0= -ball.vy0*(1-0.5*Math.random());if(ball.vy0<2){ball.vy0=0}hitFloor=true}if(ball.y+ball.radio>=canvas_height-ROOF_WIDTH-SIMIL_3D_FLOOR){ball.vy0= -ball.vy0*(1-0.1*Math.random());ball.y=canvas_height-ROOF_WIDTH-SIMIL_3D_FLOOR-ball.radio;hitCeiling=true}if(ball.x+ball.radio>=canvas_width-RIGHT_WALL_WIDTH){ball.vx0= -ball.vx0*(1-0.2*Math.random());ball.x=canvas_width-RIGHT_WALL_WIDTH-ball.radio;hitWall=true}if(ball.vx0<0){if(ball.x-ball.radio<=leftWallPosition+anchoParedIzquierda*0.5&&ball.x-ball.radio>leftWallPosition){if(Number(ball.y+ball.radio)>=Number(FLOOR_WIDTH+alturaPortal)){let rand=Math.random();if(rand<0.3){ball.vx0= -ball.vx0;}else if(rand<0.6){ball.vx0=0}else{ball.vy0=0;ball.run=false;ball.reason="crash";ball.callbackReject(ball);}}}else if(Number(ball.y+ball.radio)<Number(canvas_height+alturaPortal)){if(ball.x-ball.radio<=-2*ball.radio){ball.run=false;ball.callbackGOAL(ball);}}}if(ball.vx0==0&&ball.vy0==0){ball.run=false;ball.reason="hang";ball.callbackReject(ball)}return[hitCeiling,hitWall,hitFloor]}let animation=[];function initBallScene(divId,balls){Ball.indexStatic=0;const canvas=document.getElementById("canvas_"+divId)||crearCanvas("canvas_"+divId);canvas.style.overflow="hidden";document.getElementById(divId).appendChild(canvas);animation[divId]=window.requestAnimationFrame(function(){animateBallScene(divId,balls)})}function rgbStrToArr(str){ret=str.replace(/[^\d,.]/g,"").split(",");if(ret.length==3){ret.push("1");}return ret.map(Number)}function rgbArrToStr(colorArr,round=false){if(round){f=Math.round}else{f=(x)=>{return x}}if(colorArr.length==3){return("rgb("+f(colorArr[0])+", "+f(colorArr[1])+", "+f(colorArr[2])+")")}else if(colorArr.length==4){return("rgba("+f(colorArr[0])+", "+f(colorArr[1])+", "+f(colorArr[2])+", "+colorArr[3]+")")}else{console.log("color error");return}}let crearCanvas=function(canvasId){width="100%";height="100%";const canvas=document.createElement("canvas");canvas.id=canvasId;canvas.width=width;canvas.height=height;return canvas};const primerosTresColores=["rgba(250,10,10,.9)","rgba(10,250,10,.9)","rgba(10,10,250,.9)"];let primerosTresColoresIndex=0;function randomColor(alpha){if(primerosTresColoresIndex<3){let ret=primerosTresColores[primerosTresColoresIndex];primerosTresColoresIndex+=1;return ret}let r=255*Math.random();let g=255*Math.random();let b=255*Math.random();return rgbArrToStr([r,g,b,alpha])}function transparentarToFixed(color,fixed){if(fixed>1){return color}arr=rgbStrToArr(color);arr[3]=fixed;return rgbArrToStr(arr)}function transparentar(color,rate){if(rate>=1){return color}const arr=rgbStrToArr(color);arr[3]=arr[3]*rate;return rgbArrToStr(arr)}function sat(arr,tope){return arr.map((item)=>(item>tope?tope:item))}function combinarColores(color1,color2,rate=0.5){const c1=rgbStrToArr(color1);const c2=rgbStrToArr(color2);const c3=[];for(i=0;i<c1.length;i+=1){c3.push(c1[i]*(1-rate)+c2[i]*rate)}return rgbArrToStr(c3)}function brillo(color,rate){arr=rgbStrToArr(color);if(rate>1){if(arr[0]==0){arr[0]=1}if(arr[1]==0){arr[1]=1}if(arr[2]==0){arr[2]=1}}arr[0]=arr[0]*rate;arr[1]=arr[1]*rate;arr[2]=arr[2]*rate;arr=sat(arr,255);return rgbArrToStr(arr)}function coordenadaInvertidaY(canvas_height,ball){return canvas_height-ball.y-ball.radio}function drawBall(ctx,ball,canvas_height,hitFloor,hitCeiling,hitWall){let dureza=0.5;let durezaInv=2-dureza;if(hitFloor||hitCeiling){dureza=1-(0.5*Math.abs(ball.vy0))/MAXVY;durezaInv=2-dureza;const signo=hitCeiling?-1:1;ctx.ellipse(ball.x,coordenadaInvertidaY(canvas_height,ball)+signo*ball.radio*(1-dureza),ball.radio*durezaInv,ball.radio*dureza,0,0,2*Math.PI)}else if(hitWall){dureza=1-(0.5*Math.abs(ball.vx0))/MAXVX;durezaInv=2-dureza;ctx.ellipse(ball.x+ball.radio*(1-dureza),coordenadaInvertidaY(canvas_height,ball),ball.radio*dureza,ball.radio*durezaInv,0,0,2*Math.PI)}else{ctx.arc(ball.x,coordenadaInvertidaY(canvas_height,ball),ball.radio,0,2*Math.PI)}}function computeBallCollisions(balls,ball){if(Ball.collisionEnabled){balls.filter((obj)=>obj.index!=ball.index&&obj.run&&!obj.paused).forEach((otherBall)=>{if(Math.pow(otherBall.x-ball.x,2)+Math.pow(otherBall.y-ball.y,2)<=Math.pow(ball.radio+otherBall.radio,2)*1.1){let buffvx0=ball.vx0;let buffvy0=ball.vy0;let otherbuffvx0=otherBall.vx0;let otherbuffvy0=otherBall.vy0;let sumaRadios=ball.radio+otherBall.radio;ball.vx0=((ball.radio-otherBall.radio)/sumaRadios)*buffvx0+((2*otherBall.radio)/sumaRadios)*otherbuffvx0;otherBall.vx0=((2*ball.radio)/sumaRadios)*buffvx0+((otherBall.radio-ball.radio)/sumaRadios)*otherbuffvx0;ball.vy0=((ball.radio-otherBall.radio)/sumaRadios)*buffvy0+((2*otherBall.radio)/sumaRadios)*otherbuffvy0;otherBall.vy0=((2*ball.radio)/sumaRadios)*buffvy0+((otherBall.radio-ball.radio)/sumaRadios)*otherbuffvy0}})}}function updatePosition(ball){ball.vy0-=GRAVITY;ball.vx0+=0;ball.y+=ball.vy0*0.5;ball.x+=ball.vx0*0.5}function computePositionAndDrawBalls(balls,ball,ctx,canvas_width,canvas_height){let hitFloor;let hitWall;let hitCeiling;if(ball.run&&!ball.paused){updatePosition(ball);ball.color=transparentarToFixed(ball.color,1);[hitCeiling,hitWall,hitFloor]=computeWallCollisions(ball,canvas_width,canvas_height);if(hitWall){ball.hit=true}computeBallCollisions(balls,ball)}else{if(ball.run&&ball.paused){ball.color=transparentarToFixed(ball.color,0.5)}else{ball.color=transparentarToFixed(ball.color,0.2)}}ctx.save();ctx.beginPath();drawBall(ctx,ball,canvas_height,hitFloor,hitCeiling,hitWall);const style3d=true;if(style3d){const grd=ctx.createRadialGradient(ball.x+ball.radio*(0.5-ball.x/canvas_width),coordenadaInvertidaY(canvas_height,ball)-ball.radio+(ball.radio*coordenadaInvertidaY(canvas_height,ball))/canvas_height,0,ball.x,coordenadaInvertidaY(canvas_height,ball)-ball.radio+(ball.radio*coordenadaInvertidaY(canvas_height,ball))/canvas_height,ball.radio*2);grd.addColorStop(0,brillo(ball.color,2));grd.addColorStop(0.3,ball.color);grd.addColorStop(1,brillo(ball.color,0.3));ctx.fillStyle=grd}else{ctx.fillStyle=ball.color}ctx.fill();ctx.fillStyle="#fff";ctx.font="15px Arial";ctx.fillText(ball.index,ball.x-5*(ball.index+"").length,coordenadaInvertidaY(canvas_height,ball)+5)}function drawScenario(ctx,canvas_width,canvas_height){ctx.save();ctx.fillStyle=patternFloor;ctx.translate(0,canvas_height-FLOOR_WIDTH);ctx.fillRect(0,0,canvas_width,FLOOR_WIDTH);ctx.restore();ctx.save();ctx.fillStyle=patternFloor;ctx.translate(0,0);ctx.fillRect(0,0,canvas_width,ROOF_WIDTH);ctx.restore();ctx.save();ctx.fillStyle=patternWall;ctx.translate(canvas_width-RIGHT_WALL_WIDTH,0);ctx.fillRect(0,0,RIGHT_WALL_WIDTH,canvas_height);ctx.restore();ctx.save();ctx.fillStyle=patternLeft;ctx.translate(leftWallPosition,0);ctx.fillRect(0,0,anchoParedIzquierda,canvas_height-FLOOR_WIDTH-alturaPortal);ctx.restore()}function animateBallScene(divId,balls){const canvas=document.getElementById("canvas_"+divId);const ctx=canvas.getContext("2d");const cs=getComputedStyle(canvas);const canvas_width=parseInt(cs.getPropertyValue("width"),10);const canvas_height=parseInt(cs.getPropertyValue("height"),10);const pit=canvas_width/18;setTimeout(function(){animation[divId]=window.requestAnimationFrame(function(){animateBallScene(divId,balls)});if(!patternLeft){try{patternLeft=ctx.createPattern(imgPinchos,"repeat-y");patternFloor=ctx.createPattern(imgFloor,"repeat-x");patternWall=ctx.createPattern(imgWall,"repeat-y");}catch(e){console.log(e);patternLeft="lightblue";patternFloor="lightblue";patternWall="lightblue"}}ctx.fillStyle="#222";ctx.fillRect(0,0,canvas_width-RIGHT_WALL_WIDTH,canvas_height-FLOOR_WIDTH);drawScenario(ctx,canvas_width,canvas_height);balls.forEach((ball)=>{computePositionAndDrawBalls(balls,ball,ctx,canvas_width,canvas_height)})},1000/fps)}function endBalls(divId,text){const canvas=document.getElementById("canvas_"+divId)||crearCanvas("canvas_"+divId);const ctx=canvas.getContext("2d");const cs=getComputedStyle(canvas);const canvas_width=parseInt(cs.getPropertyValue("width"),10);const canvas_height=parseInt(cs.getPropertyValue("height"),10);ctx.fillStyle="orange";const fontSize=80;ctx.font=fontSize+"px Arial";ctx.fillText(text,canvas_width/2-((text.length/2)*fontSize)/2,canvas_height/3);console.log(text);if(animation[divId]){cancelAnimationFrame(animation[divId])}}